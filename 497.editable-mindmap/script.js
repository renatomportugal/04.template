!function(e){var a,t={init:function(s){var n=e(this);a=e.extend({nodeClass:"node",nodeInputClass:"node_input",nodeTextClass:"node_text",activeClass:"node_active",editableClass:"node_editable",rootClass:"node_root",childrenClass:"children",childrenItemClass:"children_item",leftBranch:"children_leftbranch",rightBranch:"children_rightbranch",root:n,balance:!0},s),a.nodes=n.find("."+a.nodeClass),a.nodeInput=n.find("."+a.nodeInputClass),n.find(a.activeClass).length?a.activeNode=n.find(a.activeClass):a.activeNode=null,e(document).on("keydown",function(s){if(a.activeNode){var n,l,r,i=s.which||s.keyCode,d=a.activeNode;switch(i){case 13:if(d.hasClass(a.editableClass))return t.blur(),t.setActive(d),!1;if(d.hasClass(a.rootClass))return;t.addNode();break;case 9:d.hasClass(a.editableClass)?(t.blur(),t.setActive(d)):(s.preventDefault(),t.addChildNode());break;case 27:break;case 8:case 46:if(d.hasClass(a.editableClass))return!0;if(d.hasClass(a.rootClass))return!1;l=d.parent().next().children("."+a.nodeClass),r=d.parent().parent().prev(),s.preventDefault(),t.removeNode(),l.length?(l.addClass(a.activeClass),a.activeNode=l):(r.addClass(a.activeClass),a.activeNode=r);break;case 37:if(d.hasClass(a.editableClass))return!0;d.hasClass(a.rootClass)?t.selectChildNode(e("."+a.leftBranch)):d.closest("."+a.rightBranch).length?t.selectParentNode():t.selectChildNode();break;case 38:if(d.hasClass(a.editableClass))return!0;n=d.parent().prev().children("."+a.nodeClass),n.length&&(t.blur(),t.setActive(n));break;case 39:if(d.hasClass(a.editableClass))return!0;d.hasClass(a.rootClass)?t.selectChildNode(e("."+a.rightBranch)):d.closest("."+a.rightBranch).length?t.selectChildNode():t.selectParentNode();break;case 40:if(d.hasClass(a.editableClass))return!0;l=d.parent().next().children("."+a.nodeClass),l.length&&(t.blur(),t.setActive(l))}}}),n.on("click","."+a.nodeClass,function(){var s=e(this);s.hasClass(a.activeClass)?(t.blur(),t.setActive(s),t.setEditable(s)):(t.blur(),t.setActive(s))}).on("input paste","."+a.nodeInputClass,function(){var t=a.activeNode,s=t.find("."+a.nodeTextClass),n=e(this);s.text(n.val())}).on("keydown","."+a.nodeInputClass,function(e){var a=e.which||e.keyCode;9===a&&e.preventDefault()})},destroy:function(){e(window).unbind(".mindmap")},selectParentNode:function(){var e,s=a.activeNode,n=s.parent().parent().parent();e=n.children("."+a.nodeClass),t.blur(),t.setActive(e)},selectChildNode:function(e){var s,n=a.activeNode;e||(e=n.parent().children("."+a.childrenClass)),s=e.children("."+a.childrenItemClass+":first-child").children("."+a.nodeClass),s.length&&(t.blur(),t.setActive(s))},removeNode:function(){var e=a.activeNode,s=e.parent(),n=s.parent(),l=n.children().length-1;l?s.remove():n.remove(),t.blur(),t.balance()},addNode:function(){var e,s,n=a.activeNode.parent().parent();n.append(t.getTemplate(1)),e=n.children("."+a.childrenItemClass+":last"),s=e.children("."+a.nodeClass),t.blur(),t.setEditable(s),t.balance()},addChildNode:function(){var e,s,n=a.activeNode.parent(),l=n.children("."+a.childrenClass);l.length?(a.activeNode.hasClass(a.rootClass)&&2===l.length&&(l=l.filter("."+a.leftBranch)),l.append(t.getTemplate(1)),e=l.children("."+a.childrenItemClass+":last"),s=e.children("."+a.nodeClass)):(n.append(t.getTemplate(1,1)),l=n.children("."+a.childrenClass),e=l.children("."+a.childrenItemClass+":last"),s=e.children("."+a.nodeClass)),t.blur(),t.setEditable(s),t.balance()},blur:function(){if(a.activeNode){var e=a.activeNode,t=e.find("."+a.nodeTextClass),s=e.find("."+a.nodeInputClass);e.hasClass(a.editableClass)&&(t.text(s.val()),s.blur()),e.removeClass(a.activeClass).removeClass(a.editableClass),a.activeNode=null}},setActive:function(e){e.addClass(a.activeClass),a.activeNode=e},setEditable:function(e){var t=e.find("."+a.nodeInputClass),s=e.find("."+a.nodeTextClass);e.addClass(a.activeClass).addClass(a.editableClass).attr("data-value",s.text()),t.val(s.text()).focus().select(),a.activeNode=e},balance:function(){if(a.balance){var s,n,l,r,i,d=0,o=e("."+a.rightBranch),c=e("."+a.leftBranch),h=0,C=a.root.children("."+a.childrenClass);if(!o.length)if(i=C.not("."+a.leftBranch),i.length)i.addClass(a.rightBranch);else{if(!C.length)return;C.eq(0).removeClass(a.leftBranch).addClass(a.rightBranch).appendTo(a.root)}if(!c.length)if(i=C.not("."+a.rightBranch),i.length)i.addClass(a.leftBranch);else{if(!C.length)return;a.root.prepend(t.getTemplate(0,1)),a.root.children("."+a.childrenClass).not("."+a.rightBranch).addClass(a.leftBranch)}r=c.children(),l=o.children(),h=o.outerHeight()+c.outerHeight(),s=.5*h;for(var u=0,v=l.length;v>u;u++){if(d+=l.eq(u).outerHeight(),n=Math.abs(.5*h-d),!(s>=n))return void t.moveNodes(1,u,v);s=n}for(var f=0,p=r.length;p>f;f++){if(d+=r.eq(f).outerHeight(),n=Math.abs(.5*h-d),!(s>=n))return void(f>0&&t.moveNodes(0,0,f-1));s=n}t.clearEmptyBranches()}},moveNodes:function(s,n,l){var r,i,d;i=e(s?"."+a.rightBranch:"."+a.leftBranch),d=e(s?"."+a.leftBranch:"."+a.rightBranch),r=i.children(),r.each(function(a){a>=n&&l>=a&&e(this).appendTo(d)}),t.clearEmptyBranches()},clearEmptyBranches:function(){var t=a.root.children("."+a.childrenClass);t.each(function(){e(this).children().length||e(this).remove()})},getTemplate:function(e,t){var s="";return s+=t?' <ol class="'+a.childrenClass+'">':"",s+=e?'<li class="'+a.childrenItemClass+'"><div class="'+a.nodeClass+'"><div class="'+a.nodeTextClass+'">Node</div><input class="'+a.nodeInputClass+'" type="text"></div></li> ':"",s+=t?"</ol>":""}};e.fn.mindmap=function(a){return t[a]?t[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?void e.error("Unknown method: "+a):t.init.apply(this,arguments)}}(jQuery),$(function(){var e=!1,a=0,t=0;$(window).on("mousemove touchmove",function(s){if(e===!0){var n=$(window).scrollTop()+(a-s.pageY),l=$(window).scrollLeft()+(t-s.pageX);$(window).scrollTop(n),$(window).scrollLeft(l)}}),$(window).on("mousedown touchstart",function(s){e=!0,a=s.pageY,t=s.pageX}),$(window).on("mouseup touchend",function(){e=!1})});

$(function() {
  $('.mindmap').mindmap();
  $('.collapse_btn').on('click', function(){
    $(this).parent().toggleClass('collapsed');
  });
  function readURL(input) {
    if(input.files && input.files[0]){
      var reader = new FileReader();
      reader.onload = function(e){ $('.node_root img').attr('src',e.target.result); }
      reader.readAsDataURL(input.files[0]);
    }
  }

  $('.node_root input').on('change',function(){
    readURL(this);
  });
});